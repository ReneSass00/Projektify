@page "/customers"
@inject ICustomerService CustomerService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@using Projektify.Web.Dialogs
<PageTitle>Kunden</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="my-4">
    <!-- Zentriert den Inhalt, besser für Responsivität -->
    <MudText Typo="Typo.h4" GutterBottom="true">Kundenverwaltung</MudText>
    <MudText Class="mb-4">Hier kannst du alle deine Kunden zentral verwalten, neue anlegen, bestehende bearbeiten oder nicht mehr benötigte archivieren.</MudText>
    <MudTable T="Customer" ServerData="@ServerReload"
              Dense="true" Hover="true" Elevation="1" @ref="_table">
        <ToolBarContent>
            <MudGrid Spacing="2" Justify="Justify.FlexStart" Class="ml-4">
                <!-- Links starten, mit etwas Abstand -->
                <MudItem>
                    <MudTextField T="string" Value="_searchTerm" Placeholder="Suche nach Firmenname" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search"
                                  DebounceInterval="500" Immediate="true" ValueChanged="@(async (string value) => { _searchTerm = value; await _table.ReloadServerData(); })"
                                  Clearable="true" />
                </MudItem>
                <MudItem>
                    <MudSwitch @bind-Checked="_showArchived" ValueChanged="@(async (bool value) => await OnShowArchivedChanged(value))" Label="Archivierte anzeigen" Color="Color.Primary" />
                </MudItem>
            </MudGrid>
            <MudSpacer />  <!-- Füllt den Raum und schiebt den Button nach rechts -->
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="() => OpenDialog(Guid.Empty)">
                Neuen Kunden anlegen
            </MudButton>
        </ToolBarContent>
        <HeaderContent>
            <MudTh><MudTableSortLabel T="Customer" SortLabel="company_name">Firma</MudTableSortLabel></MudTh>
            <MudTh><MudTableSortLabel T="Customer" SortLabel="contact_name">Ansprechpartner</MudTableSortLabel></MudTh>
            <MudTh><MudTableSortLabel T="Customer" SortLabel="email">E-Mail</MudTableSortLabel></MudTh>
            <MudTh Style="text-align:right">Aktionen</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Firma">@context.CompanyName</MudTd>
            <MudTd DataLabel="Ansprechpartner">@context.ContactName</MudTd>
            <MudTd DataLabel="E-Mail">@context.Email</MudTd>
            <MudTd DataLabel="Aktionen" Style="text-align:right">
                <MudIconButton Icon="@Icons.Material.Filled.Edit" Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small" OnClick="() => OpenDialog(context.Id)" />
                <MudIconButton Icon="@Icons.Material.Filled.Archive" Variant="Variant.Filled" Color="Color.Warning" Size="Size.Small" Class="ml-2" OnClick="() => ArchiveCustomer(context.Id, context.CompanyName)" />
            </MudTd>
        </RowTemplate>
        <NoRecordsContent>
            <MudText>Keine Kunden gefunden. Zeit, den ersten anzulegen!</MudText>
        </NoRecordsContent>
        <LoadingContent>
            <MudProgressCircular Indeterminate="true" />  <!-- Besserer Loading-Indicator -->
        </LoadingContent>
        <PagerContent>
            <MudTablePager />
        </PagerContent>
    </MudTable>
</MudContainer>

@code {
    private MudTable<Customer> _table = default!;
    private string _searchTerm = string.Empty;
    private bool _showArchived = false;

    private async Task<TableData<Customer>> ServerReload(TableState state, CancellationToken token)
    {
        var data = await CustomerService.GetAllCustomersAsync(_showArchived);
        if (!string.IsNullOrWhiteSpace(_searchTerm))
        {
            data = data.Where(c => c.CompanyName.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase)).ToList();
        }
        // Hier könntest du später Paging und Sortierung aus dem 'state' hinzufügen
        return new TableData<Customer>() { TotalItems = data.Count, Items = data };
    }

    private async Task OnShowArchivedChanged(bool value)
    {
        _showArchived = value;
        await _table.ReloadServerData();
    }

    private async Task OpenDialog(Guid customerId)
    {
        var parameters = new DialogParameters();
        Customer customerToEdit;
        if (customerId == Guid.Empty)
        {
            customerToEdit = new Customer();
            parameters.Add(nameof(CustomerDialog.CustomerModel), customerToEdit);
        }
        else
        {
            customerToEdit = await CustomerService.GetCustomerByIdAsync(customerId);
            if (customerToEdit == null)
            {
                Snackbar.Add("Kunde nicht gefunden.", Severity.Error);
                return;
            }
            parameters.Add(nameof(CustomerDialog.CustomerModel), customerToEdit);
        }
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = DialogService.Show<Projektify.Web.Dialogs.CustomerDialog>(customerId == Guid.Empty ? "Neuen Kunden anlegen" : "Kunde bearbeiten", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            await _table.ReloadServerData();
        }
    }

    private async Task ArchiveCustomer(Guid customerId, string customerName)
    {
        var result = await DialogService.ShowMessageBox(
            "Kunde archivieren",
            $"Möchtest du den Kunden '{customerName}' wirklich archivieren? Bestehende Projekte und Rechnungen bleiben erhalten.",
            yesText: "Archivieren",
            cancelText: "Abbrechen",
            options: new DialogOptions { MaxWidth = MaxWidth.ExtraSmall });
        if (result.GetValueOrDefault())
        {
            try
            {
                await CustomerService.ArchiveCustomerAsync(customerId);
                Snackbar.Add($"Kunde '{customerName}' wurde archiviert.", Severity.Success);
                await _table.ReloadServerData();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Fehler beim Archivieren: {ex.Message}", Severity.Error);
            }
        }
    }
}